const express = require('express');
const router = express.Router();
const { getConnection, sql } = require('../config/database');
const notificationsService = require('../services/notificationsService');

// ‚ö†Ô∏è JSON DEPRECADO - Ahora se usa SP_OBTENER_FACTURAS y SP_GENERAR_FACTURA_DESDE_OT

// GET /api/invoices - Obtener facturas desde BD usando SP_OBTENER_FACTURAS
router.get('/', async (req, res) => {
  try {
    const { factura_id, cliente_id, numero, estado, fecha_inicio, fecha_fin } = req.query;
    
    console.log('üìã Obteniendo facturas desde BD...');
    
    const pool = await getConnection();
    const result = await pool.request()
      .input('factura_id', sql.Int, factura_id ? parseInt(factura_id) : null)
      .input('cliente_id', sql.Int, cliente_id ? parseInt(cliente_id) : null)
      .input('numero', sql.VarChar(40), numero || null)
      .input('estado', sql.VarChar(50), estado || null)
      .input('fecha_inicio', sql.Date, fecha_inicio || null)
      .input('fecha_fin', sql.Date, fecha_fin || null)
      .execute('SP_OBTENER_FACTURAS');
    
    const facturas = result.recordset || [];
    console.log(`‚úÖ ${facturas.length} facturas obtenidas desde BD`);
    
    res.json({ 
      success: true, 
      data: facturas,
      count: facturas.length 
    });
  } catch (error) {
    console.error('‚ùå Error obteniendo facturas desde BD:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Error obteniendo facturas desde BD', 
      error: error.message 
    });
  }
});

// GET /api/invoices/:id - Obtener una factura espec√≠fica
router.get('/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    console.log(`üìÑ Obteniendo factura ${id} desde BD...`);
    
    const pool = await getConnection();
    
    // Intentar buscar por factura_id primero
    let result = await pool.request()
      .input('factura_id', sql.Int, !isNaN(parseInt(id)) ? parseInt(id) : null)
      .input('cliente_id', sql.Int, null)
      .input('numero', sql.VarChar(40), null)
      .input('estado', sql.VarChar(50), null)
      .input('fecha_inicio', sql.Date, null)
      .input('fecha_fin', sql.Date, null)
      .execute('SP_OBTENER_FACTURAS');
    
    // Si no se encontr√≥ por ID, buscar por n√∫mero
    if (!result.recordset || result.recordset.length === 0) {
      result = await pool.request()
        .input('factura_id', sql.Int, null)
        .input('cliente_id', sql.Int, null)
        .input('numero', sql.VarChar(40), id)
        .input('estado', sql.VarChar(50), null)
        .input('fecha_inicio', sql.Date, null)
        .input('fecha_fin', sql.Date, null)
        .execute('SP_OBTENER_FACTURAS');
    }
    
    if (!result.recordset || result.recordset.length === 0) {
      return res.status(404).json({ 
        success: false, 
        message: 'Factura no encontrada' 
      });
    }
    
    console.log(`‚úÖ Factura ${id} encontrada`);
    
    res.json({ 
      success: true, 
      data: result.recordset[0] 
    });
  } catch (error) {
    console.error('‚ùå Error obteniendo factura:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Error obteniendo factura', 
      error: error.message 
    });
  }
});
    res.status(500).json({ success: false, message: 'Error leyendo factura', error: error.message });
  }
});

// POST create
router.post('/', async (req, res) => {
  try {
    const payload = req.body || {};
    const invoices = await readInvoices();

    const newInv = {
      id: `inv-${Date.now()}-${uuidv4().slice(0,6)}`,
      numero: generateInvoiceNumber(invoices),
      fecha: payload.fecha || new Date().toISOString(),
      clientId: payload.clientId || null,
      clientName: payload.clientName || 'CONSUMIDOR FINAL',
      items: payload.items || [],
      subtotal: payload.subtotal || 0,
      exento: payload.exento || 0,
      exonerado: payload.exonerado || 0,
      tax: payload.tax || 0,
      discount: payload.discount || 0,
      total: payload.total || 0,
      metodoPago: payload.metodoPago || 'Efectivo',
      estado: payload.estado || 'pagada',
      createdAt: new Date().toISOString(),
      createdBy: payload.createdBy || 'sistema'
    };

    invoices.push(newInv);
    await writeInvoices(invoices);

    // Enviar notificaci√≥n al cliente si existe clientId
    try {
      if (newInv.clientId) {
        await notificationsService.notifyInvoiceStatusChange(newInv.clientId, newInv, 'Creada');
      }
    } catch (notifErr) {
      console.error('Error enviando notificaci√≥n de factura creada:', notifErr);
    }

    res.status(201).json({ success: true, data: newInv });
  } catch (error) {
    console.error('Error creando factura:', error);
    res.status(500).json({ success: false, message: 'Error creando factura', error: error.message });
  }
});

// PUT update
router.put('/:id', async (req, res) => {
  try {
    const invoices = await readInvoices();
    const idx = invoices.findIndex(i => i.id === req.params.id || i.numero === req.params.id);
    if (idx === -1) return res.status(404).json({ success: false, message: 'Factura no encontrada' });

    const old = invoices[idx];
    invoices[idx] = { ...invoices[idx], ...req.body, updatedAt: new Date().toISOString() };
    await writeInvoices(invoices);

    // Si el estado cambi√≥, notificar al cliente
    try {
      const newEstado = invoices[idx].estado;
      if (old && old.estado !== newEstado && invoices[idx].clientId) {
        await notificationsService.notifyInvoiceStatusChange(invoices[idx].clientId, invoices[idx], newEstado || 'Actualizada');
      }
    } catch (notifErr) {
      console.error('Error enviando notificaci√≥n de cambio de estado de factura:', notifErr);
    }

    res.json({ success: true, data: invoices[idx] });
  } catch (error) {
    res.status(500).json({ success: false, message: 'Error actualizando factura', error: error.message });
  }
});

// DELETE
router.delete('/:id', async (req, res) => {
  try {
    const invoices = await readInvoices();
    const filtered = invoices.filter(i => !(i.id === req.params.id || i.numero === req.params.id));
    await writeInvoices(filtered);
    res.json({ success: true });
  } catch (error) {
    res.status(500).json({ success: false, message: 'Error eliminando factura', error: error.message });
  }
});

// POST /api/invoices/generate-from-ot - Generar factura desde OT usando SP
router.post('/generate-from-ot', async (req, res) => {
  try {
    const { ot_id, registrado_por } = req.body;
    
    if (!ot_id) {
      return res.status(400).json({
        success: false,
        message: 'El par√°metro ot_id es requerido'
      });
    }
    
    console.log(`üßæ Generando factura desde OT ${ot_id}...`);
    
    const pool = await getConnection();
    const result = await pool.request()
      .input('ot_id', sql.Int, parseInt(ot_id))
      .input('registrado_por', sql.Int, registrado_por || 1)
      .execute('SP_GENERAR_FACTURA_DESDE_OT');
    
    const response = result.recordset[0];
    
    if (response.allow === 1) {
      console.log(`‚úÖ Factura generada: ${response.numero_factura} (ID: ${response.factura_id})`);
      
      // Intentar enviar notificaci√≥n al cliente
      try {
        const otInfo = await pool.request()
          .input('ot_id', sql.Int, parseInt(ot_id))
          .input('cliente_id', sql.Int, null)
          .input('placa', sql.VarChar(50), null)
          .input('estado', sql.VarChar(50), null)
          .input('numero_ot', sql.VarChar(20), null)
          .execute('SP_OBTENER_ORDENES_TRABAJO');
        
        if (otInfo.recordset.length > 0) {
          const ot = otInfo.recordset[0];
          await notificationsService.notifyInvoiceGenerated(ot.cliente_id, {
            factura_id: response.factura_id,
            numero_factura: response.numero_factura,
            ot_id: ot_id,
            numero_ot: ot.numero_ot
          });
          console.log('‚úÖ Notificaci√≥n de factura generada enviada');
        }
      } catch (notifError) {
        console.error('‚ö†Ô∏è Error al enviar notificaci√≥n de factura:', notifError);
        // No fallar la operaci√≥n si la notificaci√≥n falla
      }
      
      res.json({
        success: true,
        message: response.msg,
        data: {
          factura_id: response.factura_id,
          numero_factura: response.numero_factura,
          ot_id: ot_id
        }
      });
    } else {
      console.warn(`‚ö†Ô∏è No se pudo generar factura: ${response.msg}`);
      res.status(400).json({
        success: false,
        message: response.msg
      });
    }
  } catch (error) {
    console.error('‚ùå Error generando factura desde OT:', error);
    res.status(500).json({
      success: false,
      message: 'Error al generar factura desde OT',
      error: error.message
    });
  }
});

module.exports = router;
